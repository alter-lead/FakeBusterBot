stages:
  - test

variables:
  PYTHONUNBUFFERED: "1"
  DEPLOY_ENV: "test"  # по умолчанию тестовый стенд

# Джоба для проверки backend и bot
test_backend_and_bot:
  stage: test
  image: python:3.11
  before_script:
    - python --version
    - pip install --upgrade pip
    - pip install -r backend/requirements.txt
    - pip install -r bot/requirements.txt || true
  script:
    - echo "DEPLOY_ENV = $DEPLOY_ENV"
    - echo "Проверка импорта backend"
    - python -c "import backend.app.main"
    - echo "Проверка импорта bot"
    - python -c "import bot.app.main"
  rules:
    # Запуск на ветке dev (dev стенд)
    - if: '$CI_COMMIT_BRANCH == "dev"'
      variables:
        DEPLOY_ENV: "dev"
    # Запуск на ветке test (тестовый стенд)
    - if: '$CI_COMMIT_BRANCH == "test"'
      variables:
        DEPLOY_ENV: "test"
    # Можно добавить продовую ветку main
    - if: '$CI_COMMIT_BRANCH == "main"'
      variables:
        DEPLOY_ENV: "prod"
