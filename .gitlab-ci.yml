stages:
  - test
  - build
  - deploy

variables:
  PYTHONUNBUFFERED: "1"
  DEPLOY_ENV: "test"

# =========================
# TEST STAGE
# =========================
test_backend_and_bot:
  stage: test
  image: python:3.11
  before_script:
    - python --version
    - pip install --upgrade pip
    - pip install -r backend/requirements.txt
    - pip install -r bot/requirements.txt || true
  script:
    - echo "DEPLOY_ENV = $DEPLOY_ENV"
    - echo "Проверка импорта backend"
    - python -c "import backend.app.main"
    - echo "Проверка импорта bot"
    - python -c "import bot.app.main"
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
      variables:
        DEPLOY_ENV: "dev"
    - if: '$CI_COMMIT_BRANCH == "test"'
      variables:
        DEPLOY_ENV: "test"
    - if: '$CI_COMMIT_BRANCH == "main"'
      variables:
        DEPLOY_ENV: "prod"

# =========================
# BUILD STAGE
# =========================
build_docker_image:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_DRIVER: overlay2
  script:
    - docker build -t fakebuster-backend:$CI_COMMIT_SHORT_SHA -f Dockerfile .
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
    - if: '$CI_COMMIT_BRANCH == "test"'
    - if: '$CI_COMMIT_BRANCH == "main"'

# =========================
# DEPLOY STAGE
# =========================
deploy:
  stage: deploy
  image: bitnami/kubectl:latest   # образ с shell + kubectl
  script:
    # Раскодируем kubeconfig
    - echo "$KUBE_CONFIG_B64" | base64 -d > kubeconfig.yaml
    # Деплой backend и bot
    - kubectl --kubeconfig kubeconfig.yaml apply -f k8s/backend-deployment.yaml
    - kubectl --kubeconfig kubeconfig.yaml apply -f k8s/bot-deployment.yaml
    # Проверка pod
    - kubectl --kubeconfig kubeconfig.yaml get pods -n default
  when: manual
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
    - if: '$CI_COMMIT_BRANCH == "test"'
