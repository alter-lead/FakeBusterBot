stages:
  - test
  - build
  - deploy
  - verify

variables:
  PYTHONUNBUFFERED: "1"
  DEPLOY_ENV: "test"

# =========================
# TEST STAGE
# =========================
test_backend_and_bot:
  stage: test
  image: python:3.11
  before_script:
    - python --version
    - pip install --upgrade pip
    - pip install -r backend/requirements.txt
    - pip install -r bot/requirements.txt || true
  script:
    - echo "DEPLOY_ENV = $DEPLOY_ENV"
    - echo "Проверка импорта backend"
    - python -c "import backend.app.main"
    - echo "Проверка импорта bot"
    - python -c "import bot.app.main"
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
      variables:
        DEPLOY_ENV: "dev"
    - if: '$CI_COMMIT_BRANCH == "test"'
      variables:
        DEPLOY_ENV: "test"
    - if: '$CI_COMMIT_BRANCH == "main"'
      variables:
        DEPLOY_ENV: "prod"

# =========================
# BUILD STAGE
# =========================
build_docker_images:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_DRIVER: overlay2
  script:
    # Собираем backend
    - docker build -t fakebuster-backend:$CI_COMMIT_SHORT_SHA -f Dockerfile backend/
    # Собираем bot
    - docker build -t fakebuster-bot:$CI_COMMIT_SHORT_SHA -f Dockerfile bot/
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
    - if: '$CI_COMMIT_BRANCH == "test"'
    - if: '$CI_COMMIT_BRANCH == "main"'

# =========================
# DEPLOY STAGE
# =========================
deploy_to_kubernetes:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    # создаём временный kubeconfig из Base64 переменной
    - echo "$KUBE_CONFIG_B64" | base64 -d > /tmp/kubeconfig
    - kubectl --kubeconfig /tmp/kubeconfig apply -f k8s/backend-deployment.yaml
    - kubectl --kubeconfig /tmp/kubeconfig apply -f k8s/bot-deployment.yaml
    - kubectl --kubeconfig /tmp/kubeconfig rollout status deployment backend-deployment
    - kubectl --kubeconfig /tmp/kubeconfig rollout status deployment bot-deployment
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
    - if: '$CI_COMMIT_BRANCH == "test"'
  when: manual  # можно оставить manual, если QA хочет запускать кнопкой

# =========================
# VERIFY STAGE
# =========================
verify_deploy:
  stage: verify
  image: curlimages/curl:latest
  script:
    - echo "Проверка Swagger /docs"
    - curl -f http://backend-service:8000/docs || exit 1
    - echo "Проверка Telegram Bot API"
    - curl -f https://api.telegram.org/bot$TELEGRAM_TOKEN/getMe || exit 1
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
    - if: '$CI_COMMIT_BRANCH == "test"'
